{% extends "base.html" %}
{% block title %}Title Generator - BunnyTweets{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="bi bi-chat-quote me-2"></i>Title Generator
        </h4>
        <p class="text-muted">
            Add titles/captions organized by category. Assign categories to accounts so the bot
            picks a random title from the matching pool when posting. The "Global" category is
            always included.
        </p>
    </div>
</div>

<!-- Add Title Form -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card border-secondary">
            <div class="card-header"><i class="bi bi-plus-lg me-2"></i>Add New Title</div>
            <div class="card-body">
                <form method="POST" action="/generator/title/add">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Title Text</label>
                            <textarea class="form-control" name="text" rows="2"
                                      placeholder="Enter a caption / title for tweets..." required></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category_id" required>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }} ({{ cat.count }})</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary mt-2 w-100">
                                <i class="bi bi-plus-lg me-1"></i>Add Title
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Category -->
    <div class="col-lg-4">
        <div class="card border-secondary">
            <div class="card-header"><i class="bi bi-folder-plus me-2"></i>Add Category</div>
            <div class="card-body">
                <form method="POST" action="/generator/category/add">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-2">
                        <label class="form-label">Category Name</label>
                        <input type="text" class="form-control" name="name"
                               placeholder="e.g. Cosplay" required>
                    </div>
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="bi bi-plus me-1"></i>Add Category
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Import -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-secondary">
            <div class="card-header"><i class="bi bi-upload me-2"></i>Bulk Import Titles</div>
            <div class="card-body">
                <form method="POST" action="/generator/title/bulk-add">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row g-3">
                        <div class="col-md-9">
                            <label class="form-label">Titles (one per line)</label>
                            <textarea class="form-control" name="texts" rows="5"
                                      placeholder="Paste titles here, one per line&#10;Each line becomes a separate title&#10;Empty lines are skipped" required></textarea>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category_id" required>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }} ({{ cat.count }})</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-outline-primary mt-2 w-100">
                                <i class="bi bi-upload me-1"></i>Import All
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Global Target Accounts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-people-fill me-2"></i>
                    <strong>Global Target Accounts</strong>
                    <span class="badge bg-secondary ms-1" id="gt-count">{{ global_targets|length }}</span>
                </div>
            </div>
            <div class="card-body">
                <p class="form-text mt-0 mb-3">
                    Shared retweet pool &mdash; accounts retweet from targets matching their content rating.
                    SFW accounts only see SFW targets; NSFW accounts only see NSFW targets.
                    New accounts are added here automatically when created.
                </p>

                <div id="global-targets-list" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                    {% if global_targets %}
                        {% for t in global_targets %}
                        <div class="d-inline-flex align-items-center me-2 mb-2 gt-item" data-gt-id="{{ t.id }}">
                            <span class="badge bg-dark border border-secondary d-flex align-items-center py-2 px-3" style="font-size: 0.9rem;">
                                {{ t.username }}
                                {% set rating = t.content_rating or 'sfw' %}
                                <span class="badge ms-2 {{ 'bg-success' if rating == 'sfw' else 'bg-danger' }} gt-rating"
                                      style="cursor:pointer; font-size: 0.7rem;"
                                      data-gt-id="{{ t.id }}" data-rating="{{ rating }}"
                                      onclick="toggleRating(Number(this.dataset.gtId), this.dataset.rating, this)"
                                      title="Click to toggle SFW/NSFW">{{ rating|upper }}</span>
                                <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.6rem;"
                                        onclick="deleteGlobalTarget({{ t.id }}, this)"></button>
                            </span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small" id="no-gt-msg">No global targets configured yet.</p>
                    {% endif %}
                </div>

                <div class="input-group" style="max-width: 500px;">
                    <input type="text" class="form-control form-control-sm" id="new-gt-username"
                           placeholder="@username" onkeydown="if(event.key==='Enter'){event.preventDefault();addGlobalTarget();}">
                    <select class="form-select form-select-sm" id="new-gt-rating" style="max-width: 100px;">
                        <option value="sfw">SFW</option>
                        <option value="nsfw">NSFW</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addGlobalTarget()">
                        <i class="bi bi-plus me-1"></i>Add Target
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Categories & Titles -->
<div class="row">
    {% for cat in categories %}
    <div class="col-xl-4 col-lg-6 mb-3">
        <div class="card border-secondary h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-folder me-1"></i>
                    <strong>{{ cat.name }}</strong>
                    <span class="badge bg-secondary ms-1">{{ cat.count }}</span>
                </div>
                {% if cat.name != 'Global' %}
                <button class="btn btn-sm btn-outline-danger"
                        data-cat-id="{{ cat.id }}" data-cat-name="{{ cat.name }}"
                        onclick="deleteCategory(Number(this.dataset.catId), this.dataset.catName)">
                    <i class="bi bi-trash"></i>
                </button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if cat.titles %}
                <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                    {% for title in cat.titles %}
                    <div class="list-group-item d-flex justify-content-between align-items-start bg-transparent">
                        <div class="me-2 small" style="word-break: break-word;">{{ title.text }}</div>
                        <button class="btn btn-sm btn-outline-danger flex-shrink-0"
                                onclick="deleteTitle({{ title.id }}, this)">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 1.5rem;"></i>
                    <p class="mt-1 mb-0 small">No titles yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/generator.js') }}"></script>
{% endblock %}
