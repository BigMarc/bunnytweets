{% extends "base.html" %}
{% block title %}{{ 'Edit' if edit else 'Add' }} Account - BunnyTweets{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <h4 class="mb-3">
            <i class="bi bi-{{ 'pencil' if edit else 'plus-lg' }} me-2"></i>
            {{ 'Edit' if edit else 'Add' }} Account
        </h4>

        <form method="POST">
            <!-- Basic Info -->
            {% set current_platform = account.get('platform', 'twitter') if account else 'twitter' %}
            {% set pcfg = account.get(current_platform, account.get('twitter', {})) if account else {} %}
            <div class="card border-secondary mb-3">
                <div class="card-header">Basic Info</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Account Name</label>
                            <input type="text" class="form-control" name="name"
                                   value="{{ account.name if account else '' }}"
                                   placeholder="e.g. MyMainAccount" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Platform</label>
                            <select class="form-select" name="platform" id="platform-select">
                                <option value="twitter" {% if current_platform == 'twitter' %}selected{% endif %}>Twitter / X</option>
                                <option value="threads" {% if current_platform == 'threads' %}selected{% endif %}>Threads.net</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="enabled" id="enabled"
                                       {% if not edit or (account and account.get('enabled', True)) %}checked{% endif %}>
                                <label class="form-check-label" for="enabled">Enabled</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Platform Credentials -->
            <div class="card border-secondary mb-3">
                <div class="card-header">
                    <i class="bi bi-person-badge me-2"></i>Platform Credentials
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="platform_username"
                                   value="{{ pcfg.get('username', '') }}"
                                   placeholder="@yourhandle" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Browser Profile ID ({{ provider }})</label>
                            <input type="text" class="form-control" name="platform_profile_id"
                                   value="{{ pcfg.get('profile_id', '') }}"
                                   placeholder="Profile ID from {{ provider }}" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Drive (optional) -->
            <div class="card border-secondary mb-3">
                <div class="card-header"><i class="bi bi-google me-2"></i>Google Drive (Optional)</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Folder ID</label>
                            <input type="text" class="form-control" name="google_drive.folder_id"
                                   value="{{ account.google_drive.folder_id if account and account.google_drive else '' }}"
                                   placeholder="Leave empty to skip Drive integration">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Check Interval (min)</label>
                            <input type="number" class="form-control" name="google_drive.check_interval_minutes"
                                   value="{{ account.google_drive.check_interval_minutes if account and account.google_drive else 15 }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posting -->
            <div class="card border-secondary mb-3">
                <div class="card-header"><i class="bi bi-send me-2"></i>Posting</div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="posting.enabled" id="posting-enabled"
                               {% if not account or account.get('posting', {}).get('enabled', True) %}checked{% endif %}>
                        <label class="form-check-label" for="posting-enabled">Enable Posting</label>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Schedule (comma-separated HH:MM)</label>
                            {% set schedule_times = [] %}
                            {% if account and account.get('posting', {}).get('schedule') %}
                                {% for s in account.posting.schedule %}
                                    {% if schedule_times.append(s.time if s is mapping else s) %}{% endif %}
                                {% endfor %}
                            {% endif %}
                            <input type="text" class="form-control" name="posting.schedule"
                                   value="{{ schedule_times|join(', ') if schedule_times else '09:00, 15:00, 20:00' }}"
                                   placeholder="09:00, 15:00, 20:00">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Default Text (optional)</label>
                            <input type="text" class="form-control" name="posting.default_text"
                                   value="{{ account.posting.default_text if account and account.posting else '' }}"
                                   placeholder="Text to include with every post">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collection (Title Categories + CTA) -->
            <div class="card border-secondary mb-3">
                <div class="card-header"><i class="bi bi-collection me-2"></i>Collection</div>
                <div class="card-body">
                    <!-- Title Categories multi-select -->
                    <label class="form-label fw-bold">Title Categories</label>
                    <p class="form-text mt-0 mb-2">Select which title categories the poster picks titles from. "Global" is always included.</p>
                    <div class="row g-2 mb-3">
                        {% for cat in all_categories %}
                        <div class="col-auto">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       name="title_category" value="{{ cat.name }}"
                                       id="cat-{{ cat.id }}"
                                       {% if cat.name == 'Global' %}checked disabled{% endif %}
                                       {% if cat.name in selected_categories %}checked{% endif %}>
                                <label class="form-check-label" for="cat-{{ cat.id }}">{{ cat.name }}</label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <!-- Hidden input to ensure Global is always sent -->
                    <input type="hidden" name="title_category" value="Global">

                    <!-- CTA Texts -->
                    <hr>
                    <label class="form-label fw-bold">CTA Texts (Self-Comments)</label>
                    <p class="form-text mt-0 mb-2">After posting, the bot waits ~1 hour then comments one of these texts under its own tweet.</p>

                    <div id="cta-list">
                        {% if cta_texts %}
                            {% for cta in cta_texts %}
                            <div class="d-flex align-items-start mb-2 cta-item" data-cta-id="{{ cta.id }}">
                                <span class="form-control form-control-sm bg-dark text-light me-2" style="min-height:auto;">{{ cta.text }}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger flex-shrink-0" onclick="deleteCta({{ cta.id }}, this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted small" id="no-cta-msg">No CTA texts configured yet.</p>
                        {% endif %}
                    </div>

                    <div class="input-group mt-2">
                        <input type="text" class="form-control form-control-sm" id="new-cta-text"
                               placeholder="e.g. Follow for more content like this!">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCta()">
                            <i class="bi bi-plus me-1"></i>Add CTA
                        </button>
                    </div>
                </div>
            </div>

            <!-- Retweeting -->
            <div class="card border-secondary mb-3">
                <div class="card-header"><i class="bi bi-repeat me-2"></i>Retweeting</div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="retweeting.enabled" id="rt-enabled"
                               {% if not account or account.get('retweeting', {}).get('enabled', True) %}checked{% endif %}>
                        <label class="form-check-label" for="rt-enabled">Enable Retweeting</label>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Daily Limit</label>
                            <input type="number" class="form-control" name="retweeting.daily_limit"
                                   value="{{ account.retweeting.daily_limit if account and account.retweeting else 3 }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Strategy</label>
                            <select class="form-select" name="retweeting.strategy">
                                <option value="latest" {% if not account or account.get('retweeting', {}).get('strategy', 'latest') == 'latest' %}selected{% endif %}>Latest</option>
                                <option value="random" {% if account and account.get('retweeting', {}).get('strategy') == 'random' %}selected{% endif %}>Random</option>
                            </select>
                        </div>
                    </div>

                    <!-- Target Profiles -->
                    <label class="form-label">Target Profiles</label>
                    <div id="targets-container">
                        {% if account and account.get('retweeting', {}).get('target_profiles') %}
                            {% for t in account.retweeting.target_profiles %}
                            <div class="row g-2 mb-2 target-row">
                                <div class="col-6">
                                    <input type="text" class="form-control form-control-sm" name="target_{{ loop.index0 }}_username"
                                           value="{{ t.username }}" placeholder="@username">
                                </div>
                                <div class="col-3">
                                    <input type="number" class="form-control form-control-sm" name="target_{{ loop.index0 }}_priority"
                                           value="{{ t.priority }}" placeholder="Priority">
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="row g-2 mb-2 target-row">
                                <div class="col-6">
                                    <input type="text" class="form-control form-control-sm" name="target_0_username" placeholder="@username">
                                </div>
                                <div class="col-3">
                                    <input type="number" class="form-control form-control-sm" name="target_0_priority" value="1" placeholder="Priority">
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addTarget()">
                        <i class="bi bi-plus me-1"></i>Add Target
                    </button>

                    <!-- Time Windows -->
                    <label class="form-label">Time Windows</label>
                    <div id="windows-container">
                        {% set windows = account.retweeting.time_windows if account and account.get('retweeting', {}).get('time_windows') else [{'start': '09:00', 'end': '12:00'}, {'start': '14:00', 'end': '17:00'}, {'start': '19:00', 'end': '22:00'}] %}
                        {% for w in windows %}
                        <div class="row g-2 mb-2 window-row">
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" name="window_{{ loop.index0 }}_start"
                                       value="{{ w.start }}" placeholder="HH:MM">
                            </div>
                            <div class="col-1 text-center pt-1">to</div>
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" name="window_{{ loop.index0 }}_end"
                                       value="{{ w.end }}" placeholder="HH:MM">
                            </div>
                            <div class="col-3">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addWindow()">
                        <i class="bi bi-plus me-1"></i>Add Time Window
                    </button>
                </div>
            </div>

            <!-- Human Simulation -->
            <div class="card border-secondary mb-3">
                <div class="card-header"><i class="bi bi-person-walking me-2"></i>Human Simulation</div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="human_simulation.enabled" id="sim-enabled"
                               {% if not account or account.get('human_simulation', {}).get('enabled', False) %}checked{% endif %}>
                        <label class="form-check-label" for="sim-enabled">Enable Human Simulation</label>
                        <div class="form-text">Bot will scroll, like, and browse like a real user to avoid detection</div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Min Duration (min)</label>
                            <input type="number" class="form-control" name="human_simulation.session_duration_min"
                                   value="{{ account.human_simulation.session_duration_min if account and account.get('human_simulation') else 30 }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Max Duration (min)</label>
                            <input type="number" class="form-control" name="human_simulation.session_duration_max"
                                   value="{{ account.human_simulation.session_duration_max if account and account.get('human_simulation') else 60 }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Daily Sessions</label>
                            <input type="number" class="form-control" name="human_simulation.daily_sessions_limit"
                                   value="{{ account.human_simulation.daily_sessions_limit if account and account.get('human_simulation') else 2 }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Daily Likes Limit</label>
                            <input type="number" class="form-control" name="human_simulation.daily_likes_limit"
                                   value="{{ account.human_simulation.daily_likes_limit if account and account.get('human_simulation') else 30 }}">
                        </div>
                    </div>

                    <!-- Simulation Time Windows -->
                    <label class="form-label">Simulation Time Windows</label>
                    <div id="sim-windows-container">
                        {% set sim_windows = account.human_simulation.time_windows if account and account.get('human_simulation', {}).get('time_windows') else [{'start': '08:00', 'end': '12:00'}, {'start': '18:00', 'end': '23:00'}] %}
                        {% for w in sim_windows %}
                        <div class="row g-2 mb-2 sim-window-row">
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" name="sim_window_{{ loop.index0 }}_start"
                                       value="{{ w.start }}" placeholder="HH:MM">
                            </div>
                            <div class="col-1 text-center pt-1">to</div>
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" name="sim_window_{{ loop.index0 }}_end"
                                       value="{{ w.end }}" placeholder="HH:MM">
                            </div>
                            <div class="col-3">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addSimWindow()">
                        <i class="bi bi-plus me-1"></i>Add Time Window
                    </button>
                </div>
            </div>

            <!-- Reply to Replies -->
            <div class="card border-secondary mb-3">
                <div class="card-header"><i class="bi bi-reply me-2"></i>Reply to Replies</div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="reply_to_replies.enabled" id="reply-enabled"
                               {% if account and account.get('reply_to_replies', {}).get('enabled', False) %}checked{% endif %}>
                        <label class="form-check-label" for="reply-enabled">Enable Auto-Replies</label>
                        <div class="form-text">Bot will check notifications and reply to mentions using templates</div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Daily Limit</label>
                            <input type="number" class="form-control" name="reply_to_replies.daily_limit"
                                   value="{{ account.reply_to_replies.daily_limit if account and account.get('reply_to_replies') else 10 }}">
                        </div>
                    </div>

                    <!-- Reply Time Windows -->
                    <label class="form-label">Reply Time Windows</label>
                    <div id="reply-windows-container">
                        {% set reply_windows = account.reply_to_replies.time_windows if account and account.get('reply_to_replies', {}).get('time_windows') else [{'start': '09:00', 'end': '22:00'}] %}
                        {% for w in reply_windows %}
                        <div class="row g-2 mb-2 reply-window-row">
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" name="reply_window_{{ loop.index0 }}_start"
                                       value="{{ w.start }}" placeholder="HH:MM">
                            </div>
                            <div class="col-1 text-center pt-1">to</div>
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" name="reply_window_{{ loop.index0 }}_end"
                                       value="{{ w.end }}" placeholder="HH:MM">
                            </div>
                            <div class="col-3">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addReplyWindow()">
                        <i class="bi bi-plus me-1"></i>Add Time Window
                    </button>

                    <!-- Reply Templates -->
                    <hr>
                    <label class="form-label fw-bold">Reply Templates</label>
                    <p class="form-text mt-0 mb-2">Bot picks a random template when replying to mentions.</p>

                    <div id="reply-template-list">
                        {% if reply_templates %}
                            {% for tpl in reply_templates %}
                            <div class="d-flex align-items-start mb-2 reply-tpl-item" data-tpl-id="{{ tpl.id }}">
                                <span class="form-control form-control-sm bg-dark text-light me-2" style="min-height:auto;">{{ tpl.text }}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger flex-shrink-0" onclick="deleteReplyTemplate({{ tpl.id }}, this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted small" id="no-reply-tpl-msg">No reply templates configured yet.</p>
                        {% endif %}
                    </div>

                    <div class="input-group mt-2">
                        <input type="text" class="form-control form-control-sm" id="new-reply-template"
                               placeholder="e.g. Thanks for the love! Check out my pinned tweet">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addReplyTemplate()">
                            <i class="bi bi-plus me-1"></i>Add Template
                        </button>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mb-4">
                <a href="/accounts" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>{{ 'Save Changes' if edit else 'Add Account' }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/accounts.js') }}"></script>
<script>
// CTA management (AJAX, not part of the main form submit)
const accountName = "{{ account.name if account else '' }}";

async function addCta() {
    const input = document.getElementById('new-cta-text');
    const text = input.value.trim();
    if (!text) return;

    try {
        const resp = await fetch(`/accounts/${encodeURIComponent(accountName)}/cta/add`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: text}),
        });
        const data = await resp.json();
        if (data.success) {
            // Remove "no CTA" message if present
            const noMsg = document.getElementById('no-cta-msg');
            if (noMsg) noMsg.remove();

            const list = document.getElementById('cta-list');
            const html = `
                <div class="d-flex align-items-start mb-2 cta-item" data-cta-id="${data.id}">
                    <span class="form-control form-control-sm bg-dark text-light me-2" style="min-height:auto;">${text}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger flex-shrink-0" onclick="deleteCta(${data.id}, this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
            input.value = '';
            showToast('CTA text added', 'success');
        } else {
            showToast(data.message || 'Failed to add CTA', 'danger');
        }
    } catch (e) {
        showToast('Failed to add CTA text', 'danger');
    }
}

async function deleteCta(ctaId, btn) {
    try {
        const resp = await fetch(`/accounts/${encodeURIComponent(accountName)}/cta/${ctaId}/delete`, {
            method: 'POST',
        });
        const data = await resp.json();
        if (data.success) {
            const item = btn.closest('.cta-item');
            if (item) item.remove();
            showToast('CTA text deleted', 'success');
        } else {
            showToast(data.message || 'Failed to delete CTA', 'danger');
        }
    } catch (e) {
        showToast('Failed to delete CTA text', 'danger');
    }
}

// Reply template management (AJAX)
async function addReplyTemplate() {
    const input = document.getElementById('new-reply-template');
    const text = input.value.trim();
    if (!text) return;

    try {
        const resp = await fetch(`/accounts/${encodeURIComponent(accountName)}/reply-template/add`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: text}),
        });
        const data = await resp.json();
        if (data.success) {
            const noMsg = document.getElementById('no-reply-tpl-msg');
            if (noMsg) noMsg.remove();

            const list = document.getElementById('reply-template-list');
            const html = `
                <div class="d-flex align-items-start mb-2 reply-tpl-item" data-tpl-id="${data.id}">
                    <span class="form-control form-control-sm bg-dark text-light me-2" style="min-height:auto;">${text}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger flex-shrink-0" onclick="deleteReplyTemplate(${data.id}, this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
            input.value = '';
            showToast('Reply template added', 'success');
        } else {
            showToast(data.message || 'Failed to add template', 'danger');
        }
    } catch (e) {
        showToast('Failed to add reply template', 'danger');
    }
}

async function deleteReplyTemplate(tplId, btn) {
    try {
        const resp = await fetch(`/accounts/${encodeURIComponent(accountName)}/reply-template/${tplId}/delete`, {
            method: 'POST',
        });
        const data = await resp.json();
        if (data.success) {
            const item = btn.closest('.reply-tpl-item');
            if (item) item.remove();
            showToast('Reply template deleted', 'success');
        } else {
            showToast(data.message || 'Failed to delete template', 'danger');
        }
    } catch (e) {
        showToast('Failed to delete reply template', 'danger');
    }
}
</script>
{% endblock %}
